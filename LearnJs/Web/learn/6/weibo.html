<style type="text/css">
body,div,h2,h3,ul,li,p{margin:0;padding:0;}
a{text-decoration:none;}
a:hover{text-decoration:underline;}
ul{list-style-type:none;}
body{color:#333;background:#3c3a3b;font:12px/1.5 \5b8b\4f53;}
#msgBox{width:500px;background:#fff;border-radius:5px;margin:10px auto;padding-top:10px;overflow: hidden;}
#msgBox form h2{font-weight:400;font:400 18px/1.5 \5fae\8f6f\96c5\9ed1;}
#msgBox form{background:url(img/boxBG.jpg) repeat-x 0 bottom;padding:0 20px 15px;}
#userName,#conBox{color:#777;border:1px solid #d0d0d0;border-radius:6px;background:#fff url(img/inputBG.png) repeat-x;padding:3px 5px;font:14px/1.5 arial;outline: none;}
#userName.active,#conBox.active{border:1px solid #7abb2c;}
/*#userName{height:20px;}*/
#conBox{width:448px;resize:none;height:65px;overflow:auto;}
#msgBox form div{position:relative;color:#999;margin-top:10px;}
#msgBox img{border-radius:3px;}
#face{position:absolute;top:0;left:172px;}
#face img{width:30px;height:30px;cursor:pointer;margin-right:6px;opacity:0.5;filter:alpha(opacity=50);}
#face img.hover,#face img.current{width:28px;height:28px;border:1px solid #f60;opacity:1;filter:alpha(opacity=100);}
#sendBtn{border:0;width:112px;height:30px;cursor:pointer;margin-left:10px;background:url(img/btn.png) no-repeat;}
#sendBtn.hover{background-position:0 -30px;}
#msgBox form .maxNum{font:26px/30px Georgia, Tahoma, Arial;padding:0 5px;}
#msgBox .list{padding:10px;}
#msgBox .list h3{position:relative;height:33px;font-size:14px;font-weight:400;background:#e3eaec;border:1px solid #dee4e7;}
#msgBox .list h3 span{position:absolute;left:6px;top:6px;background:#fff;line-height:28px;display:inline-block;padding:0 15px;}
#msgBox .list ul{overflow:hidden;zoom:1;}
#msgBox .list ul li{float:left;clear:both;width:100%;border-bottom:1px dashed #d8d8d8;padding:10px 0;background:#fff;overflow:hidden;}
#msgBox .list ul li.hover{background:#f5f5f5;}
#msgBox .list .userPic{float:left;width:50px;height:50px;display:inline;margin-left:10px;border:1px solid #ccc;border-radius:3px;}
#msgBox .list .content{float:left;width:400px;font-size:14px;margin-left:10px;font-family:arial;word-wrap:break-word;}
#msgBox .list .userName{display:inline;padding-right:5px;}
#msgBox .list .userName a{color:#2b4a78;}
#msgBox .list .msgInfo{display:inline;word-wrap:break-word;}
#msgBox .list .times{color:#889db6;font:12px/18px arial;margin-top:5px;overflow:hidden;zoom:1;}
#msgBox .list .times span{float:left;}
#msgBox .list .times a{float:right;color:#889db6;display:none;}
.tr{overflow:hidden;zoom:1;}
.tr p{float:right;line-height:30px;}
.tr *{float:left;}
</style>
<div id="msgBox">
    <form>
        <h2>来 , 说说你在做什么 , 想什么</h2>
        <div>
            <input id="userName" class="f-text" value="">
            <p id="face"><img src="img/face1.gif" class=""><img src="img/face2.gif"><img src="img/face3.gif"><img src="img/face4.gif"><img src="img/face5.gif" ><img src="img/face6.gif" ><img src="img/face7.gif"><img src="img/face8.gif"></p>
        </div>
        <div><textarea id="conBox" class="f-text"></textarea></div>
        <div class="tr">
            <p>
                <span class="countTxt">还能输入</span><strong class="maxNum" style="">140</strong><span>个字</span>
                <input id="sendBtn" type="button" value="" title="快捷键 Ctrl+Enter">
            </p>
        </div>
    </form>
    <div class="list">
        <h3><span>大家在说</span></h3>
        <ul>
            <li>
                <div class="userPic"><img src="img/face.gif"></div>
                <div class="content">
                    <div class="userName"><a href="javascript:;">日丶久生情</a>:</div>
                    <div class="msgInfo">新增删除广播功能。</div>
                    <div class="times"><span>07月05日 15:14</span><a class="del" href="javascript:;">删除</a></div>
                </div>
            </li>
            <li>
                <div class="userPic"><img src="img/face.gif"></div>
                <div class="content">
                    <div class="userName"><a href="javascript:;">日丶久生情</a>:</div>
                    <div class="msgInfo">新增Ctrl+Enter快捷键发送广播。</div>
                    <div class="times"><span>07月05日 12:20</span><a class="del" href="javascript:;">删除</a></div>
                </div>
            </li>
            <li>
                <div class="userPic"><img src="img/face.gif"></div>
                <div class="content">
                    <div class="userName"><a href="javascript:;">日丶久生情</a>:</div>
                    <div class="msgInfo">新增选择头像功能。</div>
                    <div class="times"><span>07月05日 12:08</span><a class="del" href="javascript:;">删除</a></div>
                </div>
            </li>
            <li>
                <div class="userPic"><img src="img/face.gif"></div>
                <div class="content">
                    <div class="userName"><a href="javascript:;">日丶久生情</a>:</div>
                    <div class="msgInfo">增加了记录广播时间的功能。</div>
                    <div class="times"><span>07月04日 16:55</span><a class="del" href="javascript:;">删除</a></div>
                </div>
            </li>
            <li>
                <div class="userPic"><img src="img/face.gif"></div>
                <div class="content">
                    <div class="userName"><a href="javascript:;">日丶久生情</a>:</div>
                    <div class="msgInfo">增加了输入字符检测功能，英文/半角为半个字符，汉字/全角为一个字符。</div>
                    <div class="times"><span>07月04日 08:30</span><a class="del" href="javascript:;">删除</a></div>
                </div>
            </li>
            <li>
                <div class="userPic"><img src="img/face.gif"></div>
                <div class="content">
                    <div class="userName"><a href="javascript:;">日丶久生情</a>:</div>
                    <div class="msgInfo">仿腾讯微博效果，欢迎大家测试！</div>
                    <div class="times"><span>07月03日 20:19</span><a class="del" href="javascript:;">删除</a></div>
                </div>
            </li>
        </ul>
    </div>	
</div>

<script>
	(function(){
		// like $('#id'),$('.class'),$('div')
		var Tanx=function(selector){
				return new Tanx.fn.Find(selector);
			},
			document = window.document;
		Tanx.fn=Tanx.prototype={
			Find:function(selector,parent){
				// if Tanx(null),Tanx(undefined)
				if(!selector && typeof selector != "string")
					return false;
				var result=null;
				// if id
				if(/^\#/.test(selector)){
					selector=selector.replace(/^\#/,'');
					result=document.getElementById(selector);
					if(result)
						return result;
					else
						return false;
				}else if(/^\./.test(selector)){
					// if class
					selector=selector.replace(/^\./,'');
					result=[];
					var target = parent||document;
					var nodes=target.getElementsByTagName('*');
					var classReg = new RegExp("(^| )"+ selector + "( |$)");
					for(var i=0,len=nodes.length;i<len;i++){
						if(nodes[i].className!== '' && classReg.test(nodes[i].className)){
								result.push(nodes[i]);
						}
					}
					return result;
				} else if(/^\w+$/.test(selector)){
					// if tagname
					var target = parent || document;
					return target.getElementsByTagName(selector);
				}
			},
			// like Tanx.fn.eventHandler($('#id'),'click',handler)
			eventHandler:function(element,type,handler){
				if(element.addEventListener){
					element.addEventListener(type,handler,false);
				}else if(element.attachEvent){
					element.attachEvent("on"+type,handler);
				}else{
					element["on"+type]=handler;
				}
				return true;
			},
			unEventHandler:function(element, type, handler){
			    if (element.removeEventListener){
			      element.removeEventListener(type, handler, false);
			    } else if(element.detachEvent){
			      element.detachEvent("on" + type, handler);
			    } else {
			      element["on" + type]=null;
			    }
			    return true;
			},
			// like Tanx.fn.css(div,{'opacity':100,'width':100px})
			// like Tanx.fn.css(div,'width');
			// like Tanx.fn.css(div, 'width','100px')
			css:function(element,attribute,value){
				if(typeof arguments[0] !== 'object')
					return false;
				var length=arguments.length;
				if(length==2){
					// like Tanx.fn.css(div,{'opacity':100,'width':100px})
					if(typeof attribute === 'object'){
						for(var i in attribute){
							if(i==="opacity"){
								setOpacity(element,attribute[i]);
							}else{
								element.style[i]=attribute[i];
							}
						}
					}else{
						// like Tanx.fn.css(div,'width');
						return element.currentStyle?
										element.currentStyle[attribute]:
										getComputedStyle(element,null)[attribute];
					}
				}else if(length === 3){
					// like Tanx.fn.css(div, 'width','100px')
					if(attribute==="opacity")
						setOpacity(element,value);
					else
						element.style[attribute]=value;
				}
			},
			slideUp:function(element,time,callback){
				var time=time||30;
				var pb=parseFloat(Tanx.fn.css(element,'paddingBottom'));
				var pt=parseFloat(Tanx.fn.css(element,'paddingTop'));
				var height=element.offsetHeight-pb-pt;
				var tmp=height/10;
				var opacity=100;
				var timer=setInterval(function(){
					if(opacity>0)
						Tanx.fn.css(element,{'opacity':(opacity-=10),'height':(height-=tmp)})
					else{
						Tanx.fn.css(element,'height','0');
						clearInterval(timer);
						callback.apply();
					}
				},time);
			},
			slideDown:function(element,time,callback){
				var time=time||30;
				var pb=parseFloat(Tanx.fn.css(element,'paddingBottom'));
				var pt=parseFloat(Tanx.fn.css(element,'paddingTop'));
				var height=element.offsetHeight-pb-pt;
				var tmp=parseInt(height/10);
				var sep=tmp;
				var opacity=0;
				Tanx.fn.css(element,{'opacity':0,'height':0});
				var timer=setInterval(function(){
					if(opacity<100){
						// console.log(height);
						Tanx.fn.css(element,{'height':(tmp+=sep),'opacity':(opacity+=10)})
					}else{
						clearInterval(timer);
            callback.apply();
					}
				},time);
			},
		};
		function setOpacity(element,value){
			element.style.filter="alpha(opacity="+value+")";
			element.style.opacity=value/100;
		}
		window.$=window.Tanx=Tanx;
	})()

	var msg=$('#msgBox');
	var form=$('form',msg)[0];
	// Tanx.fn.slideDown(msg);

	var face = $('#face');
	var faces = $('img',face);
	var faceIndex = 0;
	selectface();
	function selectface(){
		var i,len=faces.length;
		for(i=0;i<len;i++)
			faces[i].className="";
		faces[faceIndex].className = "current";
		for(i=0;i<len;i++){
			faces[i].index = i;
			faces[i].onmouseover = function(){
				if(this.index!=faceIndex)
					this.className = "hover";
			}
			faces[i].onmouseout = function(){
				if(this.index!=faceIndex)
					this.className = "";
			}
			faces[i].onclick = function(){
				for(var j=0;j<len;j++)
					faces[j].className="";
				faceIndex = this.index;
				this.className="current";
			}
		}
	}

	var userName = $('#userName');
	var conBox = $('#conBox');
	// 获得焦点效果
	function focus(target){
		target.onfocus=function(){
			this.className="active";
		}
		target.onblur=function(){
			this.className="";
		}
	}
	focus(userName);
	focus(conBox);


	// add submit event
	var subBtn = $('#sendBtn');
	var list = $('.list');
	var ul = $('ul',list)[0];
  var bSend=false;
	var Data = function(name, index, content){
		this.name=encodeURI(name);
		this.faceIndex=index+1;
		this.content=encodeURI(content);
		var oDate = new Date();
		this.time = {
			month:format(oDate.getMonth()+1),
			date:format(oDate.getDate()),
			hour:format(oDate.getHours()),
			minute:format(oDate.getMinutes()),
		}
	};
	subBtn.onmouseover = function(){
		this.className="hover";
	}
	subBtn.onmouseout = function(){
		this.className="";
	}
	subBtn.onclick = fnSend;
  Tanx.fn.eventHandler(document,'keyup',function(event){
    var event=event||window.event;
    if(event.ctrlKey && event.keyCode=== 13)
      fnSend();
  })

  function fnSend(){
    if(/^\s*$/.test(userName.value)){
      alert("请输入您的名字");
      userName.focus();
      return;
    } else if(!/^[u4e00-\u9fa5\w]{2,8}$/g.test(userName.value)){
      // 检测2-8位的中文名字
      alert("名字只能是2-8位的字母数字下划线汉字");
      userName.focus();
      return;
    }else if(/^\s*$/.test(conBox.value)){
      alert("请输入内容");
      conBox.focus();
      return;
    }else if(!bSend){
      alert("请合法输入");
      conBox.focus();
      return;
    }
    var data = new Data(userName.value, faceIndex, conBox.value);
    var li = document.createElement('li');
    li.innerHTML = "<div class=\"userPic\"><img src=\"img/face" + data.faceIndex + ".gif\"></div>\
               <div class=\"content\">\
                <div class=\"userName\"><a href=\"javascript:;\">" + decodeURI(data.name) + "</a>:</div>\
                <div class=\"msgInfo\">" + decodeURI(data.content.replace(/<[^>]*>|&nbsp;/ig, "")) + "</div>\
                <div class=\"times\"><span>" + data.time.month + "月" + data.time.date + "日 " + data.time.hour + ":" + data.time.minute + "</span><a class=\"del\" href=\"javascript:;\">删除</a></div>\
               </div>";
    ul.insertBefore(li,ul.firstChild);
    Tanx.fn.slideDown(li);
    lisHover();

    // reset form
    form.reset();
    faceIndex=0;
    selectface();
    number.innerHTML="140";
  }

  // 限制字数
  Tanx.fn.eventHandler(conBox,'keyup',limit);
  Tanx.fn.eventHandler(conBox,'focus',limit);
  Tanx.fn.eventHandler(conBox,'change',limit);
  Tanx.fn.eventHandler(conBox,'blur',limit);
  var number=$('.maxNum')[0];
  var countTxt=$('.countTxt')[0];
  var maxNum=parseInt(number.innerHTML);
  function limit(){
    var iLen=0;
    for(var i=0,len=conBox.value.length;i<len;i++){
      // 检测汉字或全角个数，如果不是就折半
      iLen+=/^[^\x00-\xff]/g.test(conBox.value.charAt(i))?1:0.5;
      number.innerHTML=Math.abs(maxNum-Math.floor(iLen));
      if(iLen<=maxNum){
        Tanx.fn.css(number,'color','');
        countTxt.innerHTML="还能输入";
        bSend=true;
      }else{
        Tanx.fn.css(number,'color','red');
        countTxt.innerHTML="已经超出";
        bSend=false;
      }
    }
  }

	function format(str){
		// 如果是一位数字，就在前面加个0
		return str.toString().replace(/^(\d)$/,"0$1")
	}
	// 添加删除功能
	lisHover();
	function lisHover(){
		var lis = $('li',ul);
		var delBtn;
		for(var i=0,len=lis.length;i<len;i++){
			lis[i].index=i;
			lis[i].onmouseover=function(){
				that=this;
				this.className="hover";
				// 这里我使用$('.del',this)返回的却是ul中所有的.del元素
				delBtn=this.getElementsByTagName('*')[8];
				delBtn.style.display="block";

				// 给del按钮添加删除事件
				delBtn.onclick=function(){
					Tanx.fn.slideUp(that,30,function(){
						that.parentNode.removeChild(that);
					});
				}
			};
			lis[i].onmouseout=function(){
				this.className="";
				delBtn=this.getElementsByTagName('*')[8];
				delBtn.style.display="none";
				delBtn.onclick=null;
			}
		}
	}
	
</script>