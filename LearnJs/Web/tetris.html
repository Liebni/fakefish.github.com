<html>
<head>
  <title>tetris by fakefish</title>
  <style type="text/css">
    html{background: #ccc;}
    #game{background: #fff;margin: 0 auto;}
    ul,li{list-style: none;margin: 0;padding: 0;}
    #game li{display: inline-block;}
    #game li.line{border-right: 1px solid #ccc;border-bottom: 1px solid #ccc;}
    #game li.active{background: #333};
  </style>
  <script type="text/javascript">
    window.onload=function(){
      var game=document.getElementById('game');
      tetris.init(game,{
        width:390,
        height:600,
        size_w:30,
        size_h:30,
        speed:1000,
      });
    }
    
    tetris={
      init:function(game,config){
        // first i want to draw grid lines
        this.body=game;
        this.config=config;
        this.grid();
        this.showGrid();
        // this.hiddenGrid();
        // then 
        this.box=[[0,1],[1,0],[1,1],[1,2]]
        this.render(this.box);
        this.move();
      },
      grid:function(){
        body=this.body;
        config=this.config;
        var frag=document.createDocumentFragment(),
          width=config.width,
          height=config.height,
          w=parseInt(width/config.size_w),
          h=parseInt(height/config.size_h),
          n=h*w,
          bgData=[],
          x=0,
          y=0;
        body.style.width=width+'px';
        body.style.height=height+'px';
        
        var ul=document.createElement("ul");
        var item;
        for(var i=0;i<n;i++){
          item=document.createElement("li");
          item.style.width=config.size_w;
          item.style.height=config.size_h;
          frag.appendChild(item);

          item.setAttribute('data-pos',[x,y]);
          bgData.push([x,y]);
          if(i%w!==w-1){
            y++;
          }else{
            x++;
            y=0;
          }
        }
        ul.appendChild(frag);
        body.appendChild(ul);

        this.items=ul.childNodes;
        this.bgData=bgData;

      },
      render:function(data){
        // data must like [[0,1],[1,0],[1,1],[1,2]]
        var result,arr;
        config=this.config;
        for(var i=0,len=data.length;i<len;i++){
          arr=data[i];
          result=arr[0]*parseInt(config.width/config.size_w)+arr[1];
          this.items[result].className+=" active";
        }
      },
      clean:function(data){
        var result,arr;
        config=this.config;
        for(var i=0,len=data.length;i<len;i++){
          arr=data[i];
          result=arr[0]*parseInt(config.width/config.size_w)+arr[1];
          this.items[result].className="";
        }
      },
      keydown:function(){
        var that=this;
        document.onkeydown=function(event){
          var event=event||window.event;
          switch(event.keyCode){
            case 65:
            case 37:that.bLeft=true;break;
            case 87:
            case 38:that.bTop=true;break;
            case 68:
            case 39:that.bRight=true;break;
            case 83:
            case 40:that.bBottom=true;break;
          }
        }
      },
      move:function(){
        var that=this,
            next,
            last,
            config=this.config;
        this.keydown();
        this.timer=setInterval(function(){
            var bLeft=that.bLeft,
                bTop=that.bTop,
                bRight=that.bRight,
                bBottom=that.bBottom;

        if(bLeft){
          that.moveStep("left");
          console.log("left");
        }else if(bTop){
          that.moveStep("top");
           console.log("top");
        }else if(bRight){
          that.moveStep("right");
           console.log("right");
        }else if(bBottom){
          that.moveStep("bottom");
           console.log("bottom");
        }else{
          clearInterval(that.timer);
        }

        bLeft=bTop=bRight=bBottom=false;
        },config.speed);
      },
      moveStep:function(dir){
        var box=this.box;
        var config=this.config;
        if(dir=="left" && box[1][0]>0){
          for(var i=0,len=box.length;i<len;i++){
            box[i][0]+=1;
          }
        }else if(dir=="right" && box[3][0]<parseInt()){
          for(var i=0,len=box.length;i<len;i++){
            box[i][0]-=1;
          }
        }else if(dir=="top"){
          for(var i=0,len=box.length;i<len;i++){
            box[i][1]-=1;
          }
        }else if(dir=="bottom"){
          for(var i=0,len=box.length;i<len;i++){
            box[i][1]+=1;
          }
        }
        this.clean(this.box);
        this.box=box;
        console.log(box);
        this.render(this.box);
      },

      showGrid:function(){
        items=this.items;
        config=this.config;
        for(var i=0,len=items.length;i<len;i++){
          items[i].className="line";
          items[i].style.width=config.size_w-1+'px';
          items[i].style.height=config.size_h-1+'px';
        }
      },
      hiddenGrid:function(){
        items=this.items;
        config=this.config;
        for(var i=0,len=items.length;i<len;i++){
          items[i].className="";
          items[i].style.width=config.size_w+'px';
          items[i].style.height=config.size_h+'px';
        }
      }
    }
  </script>
</head>
<body>
  <div id="game">
  </div>
</body>
</html>